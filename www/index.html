<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Demo</title>
    <script src="another.js"></script>
    <link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png>
    <link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png>
    <link rel=manifest href=/manifest.json>
    <meta name=theme-color content=#4DBA87>
    <meta name=apple-mobile-web-app-capable content=no>
    <meta name=apple-mobile-web-app-status-bar-style content=default>
    <meta name=apple-mobile-web-app-title content=customer-vue>
    <link rel=apple-touch-icon href=/img/apple-touch-icon-152x152.png>
    <link rel=mask-icon href=/img/safari-pinned-tab.svg color=#4DBA87>
    <meta name=msapplication-TileImage content=/img/msapplication-icon-144x144.png>
    <meta name=msapplication-TileColor content=#000000>
</head>
<body>
    <div id="status">Current status <b id="value"></b></div>
    <h1 id="title">Hello World !!</h1>
    <script src="app.js"></script>
    <script>
        function register (swUrl, hooks) {
            if ( hooks === void 0 ) hooks = {};

            var registrationOptions = hooks.registrationOptions; if ( registrationOptions === void 0 ) registrationOptions = {};
            delete hooks.registrationOptions

            var emit = function (hook) {
                var args = [], len = arguments.length - 1;
                while ( len-- > 0 ) args[ len ] = arguments[ len + 1 ];

                if (hooks && hooks[hook]) {
                hooks[hook].apply(hooks, args)
                }
            }

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function () {
                // if (isLocalhost()) {
                //     // This is running on localhost. Lets check if a service worker still exists or not.
                //     checkValidServiceWorker(swUrl, emit, registrationOptions)
                //     navigator.serviceWorker.ready.then(function (registration) {
                //     emit('ready', registration)
                //     })
                // } else {
                    // Is not local host. Just register service worker
                    registerValidSW(swUrl, emit, registrationOptions)
                });
            //     }
            //     })
            }
        }
        function registerValidSW (swUrl, emit, registrationOptions) {
            navigator.serviceWorker
                .register(swUrl, registrationOptions)
                .then(function (registration) {
                emit('registered', registration)
                if (registration.waiting) {
                    emit('updated', registration)
                    return
                }
                registration.onupdatefound = function () {
                    emit('updatefound', registration)
                    var installingWorker = registration.installing
                    installingWorker.onstatechange = function () {
                    if (installingWorker.state === 'installed') {
                        if (navigator.serviceWorker.controller) {
                        // At this point, the old content will have been purged and
                        // the fresh content will have been added to the cache.
                        // It's the perfect time to display a "New content is
                        // available; please refresh." message in your web app.
                        emit('updated', registration)
                        } else {
                        // At this point, everything has been precached.
                        // It's the perfect time to display a
                        // "Content is cached for offline use." message.
                        emit('cached', registration)
                        }
                    }
                    }
                }
                })
                .catch(function (error) {
                emit('error', error)
            })
        }
        function checkValidServiceWorker (swUrl, emit, registrationOptions) {
        // Check if the service worker can be found.
        fetch(swUrl)
            .then(function (response) {
            // Ensure service worker exists, and that we really are getting a JS file.
            if (response.status === 404) {
                // No service worker found.
                emit('error', new Error(("Service worker not found at " + swUrl)))
                unregister()
            } else if (response.headers.get('content-type').indexOf('javascript') === -1) {
                emit('error', new Error(
                "Expected " + swUrl + " to have javascript content-type, " +
                "but received " + (response.headers.get('content-type'))))
                unregister()
            } else {
                // Service worker found. Proceed as normal.
                registerValidSW(swUrl, emit, registrationOptions)
            }
            })
            .catch(function (error) {
            if (!navigator.onLine) {
                emit('offline')
            } else {
                emit('error', error)
            }
            })
        }
        register('service-worker.js', {
            ready () {
            console.log(
                'App is being served from cache by a service worker.\n' +
                'For more details, visit https://goo.gl/AFskqB'
            )
            },
            registered () {
            console.log('Service worker has been registered.')
            },
            cached () {
            console.log('Content has been cached for offline use.')
            },
            updatefound () {
            console.log('New content is downloading.')
            },
            updated () {
            console.log('New content is available; Refresh...')
            setTimeout(() => {
                window.location.reload(true);
            }, 1000)
            },
            offline () {
            console.log('No internet connection found. App is running in offline mode.')
            },
            error (error) {
            console.error('Error during service worker registration:', error)
            }
        })
    </script>
    <script>
        (function () {
            if (location.search !== '?sse') return;
            const EVENT_SOURCE_ENDPOINT = '/development/sse.php?watch=true';
            const ServerEvents = new EventSource(EVENT_SOURCE_ENDPOINT);
            ServerEvents.addEventListener('message', e => {
                const data = JSON.parse(e.data);
                handleServerMessage(data);
            });
            ServerEvents.addEventListener('error', e => {
                handleServerError(e);
            });

            // -------------------------------------
            handleServerMessage = data => {
                if (data && data.action && data.action === "reload") {
                    window.location.reload();
                }
            }
            handleServerError = error => {
                // console.error(error);
            }
        })();
    </script>
</body>
</html>